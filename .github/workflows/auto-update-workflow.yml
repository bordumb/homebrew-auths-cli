# GitHub Action to automatically update the Homebrew formula
# Place this in .github/workflows/ of your homebrew-auths tap repository
#
# This workflow watches for new releases in the main auths repository
# and automatically creates a PR with the updated formula

name: Auto-update Formula

on:
  repository_dispatch:
    types: [new-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (e.g., 0.0.1-rc.7)'
        required: true

jobs:
  update-formula:
    runs-on: macos-latest
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Fetch checksums
        id: checksums
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BASE_URL="https://github.com/bordumb/auths/releases/download/v${VERSION}"

          X86_64_SHA=$(curl -sL "${BASE_URL}/auths-macos-x86_64.tar.gz.sha256" | awk '{print $1}')
          ARM64_SHA=$(curl -sL "${BASE_URL}/auths-macos-aarch64.tar.gz.sha256" | awk '{print $1}')

          echo "x86_64_sha=${X86_64_SHA}" >> $GITHUB_OUTPUT
          echo "arm64_sha=${ARM64_SHA}" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          X86_64_SHA="${{ steps.checksums.outputs.x86_64_sha }}"
          ARM64_SHA="${{ steps.checksums.outputs.arm64_sha }}"

          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Formula/auths.rb

          # Update x86_64 SHA256
          sed -i '' "/Hardware::CPU.intel?/,/sha256/ s|sha256 \"[^\"]*\"|sha256 \"${X86_64_SHA}\"|" Formula/auths.rb

          # Update ARM SHA256
          sed -i '' "/Hardware::CPU.arm?/,/sha256/ s|sha256 \"[^\"]*\"|sha256 \"${ARM64_SHA}\"|" Formula/auths.rb

      - name: Test formula
        run: |
          brew audit --strict --online Formula/auths.rb
          brew install --build-from-source ./Formula/auths.rb
          brew test auths

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Update auths to v${{ steps.version.outputs.version }}"
          title: "Update auths to v${{ steps.version.outputs.version }}"
          body: |
            Automated update to auths v${{ steps.version.outputs.version }}

            **Checksums:**
            - x86_64: `${{ steps.checksums.outputs.x86_64_sha }}`
            - aarch64: `${{ steps.checksums.outputs.arm64_sha }}`

            **Release:** https://github.com/bordumb/auths/releases/tag/v${{ steps.version.outputs.version }}
          branch: "update-v${{ steps.version.outputs.version }}"
          delete-branch: true
